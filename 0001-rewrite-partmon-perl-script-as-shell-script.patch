From 865fa7787ee1e392270fcec28e92fb54c29967b2 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?"proyvind=20(Per=20=C3=98yvind=20Karlsen)"?=
 <peroyvind@mandriva.org>
Date: Fri, 4 Jan 2013 04:12:25 +0100
Subject: [PATCH] rewrite partmon perl script as shell script

---
 mandriva/partmon/Makefile   | 10 +++---
 mandriva/partmon/partmon.pl | 64 ----------------------------------
 mandriva/partmon/partmon.sh | 84 +++++++++++++++++++++++++++++++++++++++++++++
 3 files changed, 88 insertions(+), 70 deletions(-)
 delete mode 100644 mandriva/partmon/partmon.pl
 create mode 100644 mandriva/partmon/partmon.sh

diff --git a/mandriva/partmon/Makefile b/mandriva/partmon/Makefile
index 7aaa548..a8d3375 100644
--- a/mandriva/partmon/Makefile
+++ b/mandriva/partmon/Makefile
@@ -1,5 +1,4 @@
-SH=partmon
-PL=partmon.pl
+SH=partmon partmon.sh
 
 all: check
 
@@ -8,7 +7,6 @@ check:
 	@for i in $(PL);do perl -wc $$i || exit 1;done
 
 install:
-	mkdir -p $(ROOT)/usr/bin $(ROOT)/etc/rc.d/init.d
-	install -D -m755 partmon $(ROOT)/etc/rc.d/init.d/partmon
-	install -D -m755 partmon.pl $(ROOT)/usr/bin/partmon
-	install -D -m644 partmon.sysconfig $(ROOT)/etc/sysconfig/partmon
+	install -m755 partmon -D $(ROOT)/etc/rc.d/init.d/partmon
+	install -m755 partmon.sh -D $(ROOT)/usr/bin/partmon
+	install -m644 partmon.sysconfig -D $(ROOT)/etc/sysconfig/partmon
diff --git a/mandriva/partmon/partmon.pl b/mandriva/partmon/partmon.pl
deleted file mode 100644
index d6d297b..0000000
--- a/mandriva/partmon/partmon.pl
+++ /dev/null
@@ -1,64 +0,0 @@
-#!/usr/bin/perl
-#
-# Guillaume Cottenceau (gc@mandriva.com)
-#
-# Copyright 2002 Mandriva
-#
-# This software may be freely redistributed under the terms of the GNU
-# public license.
-#
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
-#
-#
-#use strict;
-use MDK::Common;
-
-my ($verbose);
-
-sub free_space {
-    my ($mntpoint) = @_;
-    my ($blocksize, $size, $avail);
-    my $buf = ' ' x 20000;
-    syscall_('statfs', $mntpoint, $buf) or return;
-    (undef, $blocksize, $size, undef, $avail, undef) = unpack "L!6", $buf;
-    return $avail * ($blocksize / 1024);
-}
-
-my %partlimits = map { if_(/^(.*\S)(?:\s+?)(\d+)$/, $1 => $2 ) } cat_('/etc/sysconfig/partmon');
-
-
-my $params = join '', @ARGV;
-
-$params =~ /-h/ and die "usage: partmon [-v]\n";
-$params =~ /-v/ and $verbose = 1;
-
-
-my $ok = 1;
-foreach (cat_('/etc/fstab')) {
-    /^\s*#/ and next;
-    my (undef, $mountpoint, undef, undef, undef, undef) = split or next;  #- I want at least 6 fields to consider it a valid entry
-    member($mountpoint, keys %partlimits) or next;
-    my $free = free_space($mountpoint);
-    $verbose and print "Free space of <$mountpoint> is <$free>\n";
-    if ($free < $partlimits{$mountpoint}) {
-	print "Warning, free space for <$mountpoint> is only <", free_space($mountpoint), "> (which is inferior to <$partlimits{$mountpoint}>\n";
-	$ok = 0;
-    }
-}
-
-$ok or exit -1;
-
-
-#-------------------------------------------------
-#- $Log$
-#- Revision 1.3  2006/05/11 12:45:38  tvignaud
-#- more s/Mandrakesoft/mandriva/
-#-
-#- Revision 1.2  2002/01/15 13:45:24  chmouel
-#- Fix warnings.
-#-
-#- Revision 1.1  2002/01/15 13:44:15  chmouel
-#- Add partition monitor from GC
-#-
diff --git a/mandriva/partmon/partmon.sh b/mandriva/partmon/partmon.sh
new file mode 100644
index 0000000..78ef924
--- /dev/null
+++ b/mandriva/partmon/partmon.sh
@@ -0,0 +1,84 @@
+#!/bin/sh
+#
+# Rewritten in shell script:
+# Copyright 2013 Per Ã˜yvind Karlsen <peroyvind@mandriva.org>
+#
+# Original perl script:
+# Guillaume Cottenceau (gc@mandriva.com)
+#
+# Copyright 2002 Mandriva
+#
+# This software may be freely redistributed under the terms of the GNU
+# public license.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+#
+#
+
+verbose=0
+while [ -n "$1" ]; do
+    if [ "$1" == "-h" ]; then
+	echo "usage: partmon [-v]"
+	exit -1
+    elif [ "$1" == "-v" ]; then
+	verbose=1
+    fi
+    shift
+done
+
+free_space() {
+    local mntpoint="$1"
+    local all="$(stat --file-system "$1" --format=%S:%b:%a)"
+    local blocksize=${all%%:*}
+    local all=${all#*:}
+    local size=${all%:*}
+    local all=${all#*:}
+    local avail=${all%:*}
+    echo $(($avail * ($blocksize / 1024)))
+}
+
+ok=1
+while read -r line
+do    
+    mountpoint="$(echo $line | sed -e 's#\s*\S*\d*$##')"
+    partlimit="$(echo $line | grep -o '\w*\d*$')"
+    case "$mountpoint" in
+	/*)
+	    if mountpoint -q "$mountpoint"; then
+		free=$(free_space "$mountpoint")
+		if [ $verbose -ne 0 ]; then
+		    echo "Free space of <$mountpoint> is <$free>";
+		fi
+		if [ $free -lt $partlimit ]; then
+		    echo "Warning, free space for <$mountpoint> is only <$free> (which is inferior to <$partlimit>)"
+		    ok=0
+		fi
+	    fi
+	    ;;
+	*) continue
+	    ;;
+    esac
+done < /etc/sysconfig/partmon
+
+if [ $ok -eq 0 ]; then
+    exit -1
+else
+    exit 0
+fi
+
+#-------------------------------------------------
+#- $Log$
+#- Revision 1.4  2013/01/04 04:03:00  proyvind
+#- rewrite from perl to schell script
+#-
+#- Revision 1.3  2006/05/11 12:45:38  tvignaud
+#- more s/Mandrakesoft/mandriva/
+#-
+#- Revision 1.2  2002/01/15 13:45:24  chmouel
+#- Fix warnings.
+#-
+#- Revision 1.1  2002/01/15 13:44:15  chmouel
+#- Add partition monitor from GC
+#-
-- 
1.7.11.3

